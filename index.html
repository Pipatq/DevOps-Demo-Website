<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moo Bell: ETH Pro Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Animation สำหรับปุ่ม Filter */
        .filter-btn {
            position: relative;
            transition: color 0.3s;
            white-space: nowrap;
            padding-bottom: 4px;
            font-size: 0.9rem;
        }
        .filter-btn::after {
            content: '';
            position: absolute;
            width: 0;
            height: 3px;
            bottom: 0;
            left: 0;
            background-color: #3b82f6;
            transition: width 0.3s ease-in-out;
        }
        .filter-btn.active {
            color: #60a5fa; /* blue-400 */
            font-weight: bold;
        }
        .filter-btn.active::after {
            width: 100%;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-8 font-sans">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl md:text-4xl font-bold mb-6 text-center text-blue-400">
            Moo Bell ETH Professional Dashboard
        </h1>
        
        <!-- Filter Controls -->
        <div class="flex flex-col lg:flex-row justify-between items-end mb-8 bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
            <div class="w-full lg:w-auto mb-4 lg:mb-0 mr-4">
                <div class="text-lg md:text-xl text-green-300 font-mono mb-2" id="date-now">Loading Time...</div>
                <div class="text-xs text-gray-500">*Data resets on refresh (Session based)</div>
            </div>
            
            <!-- Mobile Dropdown -->
            <div class="w-full block md:hidden">
                <label class="text-sm text-gray-400 mb-1 block">ช่วงเวลา (Range):</label>
                <select id="mobile-filter" onchange="setFilter(this.value)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 appearance-none">
                    <option value="1">1 นาที</option>
                    <option value="30">30 นาที</option>
                    <option value="60">1 ชั่วโมง</option>
                    <option value="1440">1 วัน</option>
                    <option value="7200">5 วัน</option>
                    <option value="ALL" selected>ทั้งหมด</option>
                </select>
            </div>

            <!-- Desktop Buttons -->
            <div class="hidden md:flex space-x-5 overflow-x-auto w-full pb-2 border-b border-gray-700 lg:border-none scrollbar-hide">
                <button onclick="setFilter(1)"        class="filter-btn text-gray-400 hover:text-white" id="btn-1m">1 นาที</button>
                <button onclick="setFilter(30)"       class="filter-btn text-gray-400 hover:text-white" id="btn-30m">30 นาที</button>
                <button onclick="setFilter(60)"       class="filter-btn text-gray-400 hover:text-white" id="btn-1h">1 ชม</button>
                <button onclick="setFilter(1440)"     class="filter-btn text-gray-400 hover:text-white" id="btn-1d">1 วัน</button>
                <button onclick="setFilter(7200)"     class="filter-btn text-gray-400 hover:text-white" id="btn-5d">5 วัน</button>
                <button onclick="setFilter(10080)"    class="filter-btn text-gray-400 hover:text-white" id="btn-1w">1 สัปดาห์</button>
                <button onclick="setFilter(43200)"    class="filter-btn text-gray-400 hover:text-white" id="btn-1M">1 เดือน</button>
                <button onclick="setFilter(525600)"   class="filter-btn text-gray-400 hover:text-white" id="btn-1Y">1 ปี</button>
                <button onclick="setFilter(2628000)"  class="filter-btn text-gray-400 hover:text-white" id="btn-5Y">5 ปี</button>
                <button onclick="setFilter('ALL')"    class="filter-btn active text-gray-400 hover:text-white" id="btn-max">สูงสุด</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- ETH / USD -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-300">ETH / USD</h2>
                    <span class="bg-gray-700 text-gray-300 px-3 py-1 rounded-full text-xs">Binance WS</span>
                </div>
                <!-- Price Display with Dynamic Color Class -->
                <p class="text-4xl font-mono mb-4 font-bold transition-colors duration-300" id="price-usd">Wait...</p>
                <div class="relative h-64 w-full"><canvas id="chartUSD"></canvas></div>
            </div>

            <!-- ETH / THB -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-300">ETH / THB</h2>
                    <span class="bg-gray-700 text-gray-300 px-3 py-1 rounded-full text-xs">Calculated</span>
                </div>
                <p class="text-4xl font-mono mb-4 font-bold transition-colors duration-300" id="price-thb">Wait...</p>
                <div class="relative h-64 w-full"><canvas id="chartTHB"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Configuration
        // ==========================================
        let currentFilterMode = 'ALL';
        let filterMinutes = 0;
        let currentExchangeRate = 34.0;

        // Theme Constants (Google Finance Style)
        const THEME = {
            UP: { border: '#10b981', fill: 'rgba(16, 185, 129, 0.5)', text: 'text-green-400' }, // Green
            DOWN: { border: '#ef4444', fill: 'rgba(239, 68, 68, 0.5)', text: 'text-red-400' }   // Red
        };

        // ==========================================
        // Custom Chart Setup (Gradient & Crosshair)
        // ==========================================
        function createChart(ctxId, label) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderWidth: 2,
                        tension: 0.1, // เส้นคมขึ้นเล็กน้อย
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderWidth: 2,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            titleColor: '#9ca3af',
                            bodyColor: '#fff',
                            bodyFont: { size: 14, weight: 'bold' },
                            borderColor: '#4b5563',
                            borderWidth: 1,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + (ctxId === 'chartUSD' ? ' USD' : ' THB');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false }, // ซ่อน Grid แนวตั้ง
                            ticks: { 
                                color: '#9ca3af', 
                                maxTicksLimit: 6,
                                maxRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            position: 'right', // ย้ายแกน Y ไปขวาเหมือนแอปเทรด
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                },
                // Plugin สำหรับเส้น Crosshair แนวตั้ง
                plugins: [{
                    afterDraw: chart => {
                        if (chart.tooltip?._active?.length) {
                            const x = chart.tooltip._active[0].element.x;
                            const yAxis = chart.scales.y;
                            const ctx = chart.ctx;
                            ctx.save();
                            ctx.beginPath();
                            ctx.moveTo(x, yAxis.top);
                            ctx.lineTo(x, yAxis.bottom);
                            ctx.lineWidth = 1;
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                            ctx.setLineDash([5, 5]); // เส้นประ
                            ctx.stroke();
                            ctx.restore();
                        }
                    }
                }]
            });
        }

        const chartUSD = createChart('chartUSD', 'ETH/USD');
        const chartTHB = createChart('chartTHB', 'ETH/THB');

        // ==========================================
        // Helper: Gradient & Color Logic
        // ==========================================
        function updateChartAppearance(chart, dataPoints) {
            if (dataPoints.length < 2) return;

            const firstPrice = dataPoints[0];
            const lastPrice = dataPoints[dataPoints.length - 1];
            const isUp = lastPrice >= firstPrice;
            const theme = isUp ? THEME.UP : THEME.DOWN;

            // 1. Update Text Color
            const textId = chart.canvas.id === 'chartUSD' ? 'price-usd' : 'price-thb';
            const textEl = document.getElementById(textId);
            textEl.className = `text-4xl font-mono mb-4 font-bold transition-colors duration-300 ${theme.text}`;

            // 2. Create Gradient Fill
            const ctx = chart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, theme.fill); // สีเข้มด้านบน
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // จางหายด้านล่าง

            // 3. Apply to Chart
            chart.data.datasets[0].borderColor = theme.border;
            chart.data.datasets[0].backgroundColor = gradient;
            chart.data.datasets[0].pointHoverBorderColor = theme.border;
        }

        // ==========================================
        // Data Handling
        // ==========================================
        const masterData = {
            usd: { data: [], timestamps: [] },
            thb: { data: [], timestamps: [] }
        };

        function recordData(type, price) {
            const now = new Date();
            masterData[type].timestamps.push(now);
            masterData[type].data.push(price);

            if (masterData[type].timestamps.length > 50000) {
                masterData[type].timestamps.shift();
                masterData[type].data.shift();
            }

            renderChart(type === 'usd' ? chartUSD : chartTHB, masterData[type]);
        }

        function renderChart(chart, sourceData) {
            if (sourceData.data.length === 0) return;

            // 1. Filter Data
            let slicedTimestamps = sourceData.timestamps;
            let slicedData = sourceData.data;

            if (currentFilterMode === 'MINUTES') {
                const now = new Date();
                const cutoff = new Date(now.getTime() - filterMinutes * 60000);
                const startIndex = sourceData.timestamps.findIndex(t => t >= cutoff);
                if (startIndex !== -1) {
                    slicedTimestamps = sourceData.timestamps.slice(startIndex);
                    slicedData = sourceData.data.slice(startIndex);
                } else {
                    slicedTimestamps = [];
                    slicedData = [];
                }
            }

            if (slicedData.length === 0) return;

            // 2. Generate Thai Buddhist Era Labels
            const labels = slicedTimestamps.map(t => {
                // ถ้าดูภาพกว้าง (มากกว่า 1 วัน) ให้แสดง วัน/เดือน
                if (filterMinutes > 1440 || currentFilterMode === 'ALL') {
                    // รูปแบบ: 18 ก.พ. (Thai Month)
                    return t.toLocaleDateString('th-TH', { 
                        day: 'numeric', 
                        month: 'short',
                        year: 'numeric' // จะได้ พ.ศ. โดยอัตโนมัติใน Locale th-TH
                    }).replace('พ.ศ. ', ''); // ตัดคำว่า พ.ศ. ออกถ้ามี ให้เหลือแต่ตัวเลข
                }
                // ถ้าดูภาพสั้น (Live/ชั่วโมง) แสดงเวลา
                return t.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            });

            // 3. Update Chart Data
            chart.data.labels = labels;
            chart.data.datasets[0].data = slicedData;

            // 4. Update Colors (Green/Red) based on sliced data
            updateChartAppearance(chart, slicedData);

            chart.update();
        }

        // ==========================================
        // Controls
        // ==========================================
        function setFilter(modeInput) {
            let mode = modeInput;
            if (mode !== 'ALL' && !isNaN(mode)) mode = parseInt(mode);

            currentFilterMode = typeof mode === 'number' ? 'MINUTES' : mode;
            filterMinutes = typeof mode === 'number' ? mode : 0;

            // Update Buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const btnMap = {
                1: 'btn-1m', 30: 'btn-30m', 60: 'btn-1h', 1440: 'btn-1d', 7200: 'btn-5d',
                10080: 'btn-1w', 43200: 'btn-1M', 525600: 'btn-1Y', 2628000: 'btn-5Y', 'ALL': 'btn-max'
            };
            if(btnMap[mode]) document.getElementById(btnMap[mode])?.classList.add('active');
            
            // Update Dropdown
            const mobileSelect = document.getElementById('mobile-filter');
            if(mobileSelect) mobileSelect.value = modeInput;

            renderChart(chartUSD, masterData.usd);
            renderChart(chartTHB, masterData.thb);
        }

        // ==========================================
        // API & Clock
        // ==========================================
        const wsBinance = new WebSocket('wss://stream.binance.com:9443/ws/ethusdt@trade');
        let lastUpdateTime = 0;

        wsBinance.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const priceUSD = parseFloat(data.p);
            const priceTHB = priceUSD * currentExchangeRate;

            document.getElementById('price-usd').innerText = `$${priceUSD.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('price-thb').innerText = `฿${priceTHB.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;

            const now = Date.now();
            if (now - lastUpdateTime > 1000) {
                recordData('usd', priceUSD);
                recordData('thb', priceTHB);
                lastUpdateTime = now;
            }
        };

        async function fetchCurrencyData() {
            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/USD?_t=${Date.now()}`);
                const data = await response.json();
                if (data?.rates?.THB) currentExchangeRate = data.rates.THB;
            } catch (e) { console.error(e); }
        }
        fetchCurrencyData();
        setInterval(fetchCurrencyData, 60000);

        // Clock with Thai Buddhist Year (พ.ศ.)
        setInterval(() => {
            const now = new Date();
            // บังคับแปลงเป็น พ.ศ. (ค.ศ. + 543)
            const thYear = now.getFullYear() + 543;
            const dateStr = now.toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric' });
            const timeStr = now.toLocaleTimeString('th-TH');
            document.getElementById('date-now').innerText = `Date Now: ${dateStr}/${thYear} ${timeStr}`;
        }, 1000);

    </script>
</body>
</html>